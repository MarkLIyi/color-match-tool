<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡é¢œè‰²æ¯”å¯¹å·¥ä½œå°</title>

    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        'primary': '#4f46e5', 
                        'secondary': '#10b981',
                        'match-bg': '#f3f4f6', /* ç»Ÿä¸€èƒŒæ™¯è‰² */
                    }
                }
            }
        };
    </script>

    <style>
        /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ä¿®å¤æ˜é“äº‘ iframe ä¸­ z-index å¯èƒ½çš„é—®é¢˜ */
        #settings-modal {
            position: fixed !important;
            z-index: 999999 !important;
            pointer-events: auto !important;
        }
    </style>
</head>

<body class="bg-match-bg min-h-screen font-sans antialiased">

<!-- é¡¶æ ï¼šæ˜¾ç¤ºå½“å‰è®°å½• ID -->
<header class="bg-white shadow-sm p-4 sticky top-0 z-10 border-b border-primary/20">
    <div class="max-w-5xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold text-gray-800">
            å½“å‰è®°å½• IDï¼š
            <span id="original-color-display" class="text-primary font-extrabold">åŠ è½½ä¸­...</span>
        </h1>
    </div>
</header>

<main class="max-w-5xl mx-auto p-4 md:p-6">

    <!-- æ–°å¢ï¼šé…ç½®è¾“å…¥å¡ç‰‡ (å½“ URL ç¼ºå°‘ rowId æ—¶æ˜¾ç¤º) -->
    <div id="config-card" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">æ‰‹åŠ¨é…ç½®åŒ¹é…ä»»åŠ¡</h2>
        <p class="text-gray-500 mb-6">è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ˜é“äº‘è®°å½• IDã€‚</p>

        <div class="space-y-4">
            <!-- è®°å½• ID è¾“å…¥ -->
            <div>
                <label for="manual-row-id" class="block text-sm font-medium text-gray-700 mb-1">è®°å½• ID (rowId)</label>
                <input type="text" id="manual-row-id" 
                       placeholder="ä¾‹å¦‚: 86c67b9e-cdfd-48f7-970a-06ee6ea270e2"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" />
            </div>
        </div>
        
        <button id="start-btn"
                class="mt-6 w-full py-3 px-8 bg-primary text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
            â–¶ å¼€å§‹åŠ è½½å¹¶åŒ¹é…
        </button>

        <p id="config-status" class="mt-4 text-center text-sm text-red-500 hidden"></p>
    </div>
    <!-- ç»“æŸï¼šé…ç½®è¾“å…¥å¡ç‰‡ -->


    <!-- åŒ¹é…å†…å®¹åŒº (ä»…å½“æœ‰ rowId æ—¶æ˜¾ç¤º) -->
    <div id="matching-content" class="hidden">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">å€™é€‰é›†å›¾ç‰‡ï¼ˆå·²æŒ‰é¢œè‰²å»é‡ï¼‰</h2>

        <div id="candidate-box" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 hide-scrollbar">
            <p id="loading" class="col-span-full text-center text-gray-500 py-6">
                æ­£åœ¨åŠ è½½å€™é€‰é¢œè‰²â€¦
            </p>
        </div>
    </div>
</main>

<!-- æ“ä½œåŒºï¼šæµ®åŠ¨åœ¨åº•éƒ¨ (ä»…å½“æœ‰ rowId æ—¶æ˜¾ç¤º) -->
<div id="footer-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-2xl p-4 z-20 hidden">
    <div class="max-w-5xl mx-auto flex justify-between items-center">
        <span id="status-message" class="text-base font-medium text-gray-700">è¯·é€‰æ‹©ä¸€ä¸ªé¢œè‰²å›¾ç‰‡</span>
        <button id="submit-btn"
                disabled
                class="py-3 px-8 bg-secondary text-white font-bold rounded-lg shadow-md hover:bg-emerald-600 disabled:opacity-50 transition duration-150 transform hover:scale-[1.02]">
            âœ“ ç¡®è®¤åŒ¹é…å¹¶ä¼ å›æ˜é“äº‘
        </button>
    </div>
</div>

<script>

/* * ========================================================== 
 * âš ï¸ è­¦å‘Šï¼šè¯·æ³¨æ„ç¡¬ç¼–ç  AppKey å’Œ Sign çš„å®‰å…¨é£é™©ï¼
 * * ğŸ› ï¸ æ’æŸ¥æ•°æ®æœªåŠ è½½ï¼š
 * 1. ç¡®ä¿ CONFIG ä¸­æ‰€æœ‰å­—æ®µ IDã€worksheetIdã€appKey å’Œ sign éƒ½æ­£ç¡®æ— è¯¯ã€‚
 * 2. ç¡®ä¿æ‚¨è¾“å…¥çš„è®°å½• ID (rowId) æ˜¯æœ‰æ•ˆçš„ã€‚
 * ========================================================== 
 */
const CONFIG = {
    // æ‚¨çš„æ˜é“äº‘ AppKey
    appKey: "681a78e1b8c72330", 
    // æ‚¨çš„ç­¾åã€‚æ³¨æ„ï¼šç¡¬ç¼–ç ç­¾åé€šå¸¸ç”¨äºæµ‹è¯•ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒåº”é€šè¿‡æœåŠ¡å™¨è®¡ç®—ã€‚
    sign: "M2NkZGZiMmM5OWIyMTUxMDQ4N2Y2YTAwZTMxNDJmM2Q3NWI5ZmU4MGU4ZDcxZjlhYWI1ZTUyOWJmNDgxYWU2OQ==", 
    // è¡¨å•ID
    worksheetId: "sjclb",

    // è·å–è®°å½• API URL
    fetchUrl: "https://www.dedlion.com/api/v2/open/worksheet/getRowByIdPost",
    // æ›´æ–°è®°å½• API URL
    updateUrl: "https://www.dedlion.com/api/v2/open/worksheet/editRowPost",

    // å­˜å‚¨å€™é€‰é›† JSON æ•°ç»„çš„å­—æ®µ ID
    candidateFieldId: "69044f51be2ffd8cd20d153e",
    // å­˜å‚¨åŒ¹é…ç»“æœï¼ˆé¢œè‰²åï¼‰çš„å­—æ®µ ID
    colorFieldId: "6901b59fbe2ffd8cd2ab5d73",
    
    // (å¯é€‰) é¢å¤–çš„å­—æ®µç”¨äºä¼ é€’å›¾ç‰‡ URLã€SKU ç­‰ã€‚
    // matchedImageFieldId: "æ‚¨å›¾ç‰‡é™„ä»¶å­—æ®µçš„ID"
    // matchedSkuFieldId: "æ‚¨åŒ¹é…SKUå­—æ®µçš„ID"
};

// ç¼“å­˜DOMå…ƒç´ ï¼Œé¿å…éšå¼å…¨å±€å˜é‡å’Œé‡å¤æŸ¥æ‰¾
const dom = {
    originalColorDisplay: document.getElementById('original-color-display'),
    candidateBox: document.getElementById('candidate-box'),
    loading: document.getElementById('loading'),
    submitBtn: document.getElementById('submit-btn'),
    statusMessage: document.getElementById('status-message'),
    
    // æ–°å¢ DOM å…ƒç´ 
    configCard: document.getElementById('config-card'),
    matchingContent: document.getElementById('matching-content'),
    footerBar: document.getElementById('footer-bar'),
    manualRowId: document.getElementById('manual-row-id'),
    startButton: document.getElementById('start-btn'),
    configStatus: document.getElementById('config-status'),
};

let selectedColor = null;
let isProcessing = false; // é˜²æ­¢é‡å¤ç‚¹å‡»
let activeRowId = null; // å­˜å‚¨å½“å‰æ­£åœ¨å¤„ç†çš„ rowId

/* ============= URL å‚æ•°è·å– ============= */

/**
 * ä» URL å‚æ•°ä¸­è·å–å½“å‰è®°å½• ID (rowId)
 */
function getUrlParams(){
    const p = new URLSearchParams(location.search);
    return {
        // æ˜é“äº‘æ ‡å‡†å‚æ•°åä¸º rowidï¼Œè¿™é‡Œå…¼å®¹ç”¨æˆ·æä¾›çš„ rowId
        rowId: p.get("rowId"), 
    };
}

/* ============= æ˜é“äº‘ POST é€šç”¨å‡½æ•° ============= */
async function mdPost(url, body){
    const r = await fetch(url,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(body)
    });
    return r.json();
}

/* ============= å¯åŠ¨åŠ è½½é€»è¾‘ï¼ˆæ¥å—æ‰‹åŠ¨è¾“å…¥æˆ– URL å‚æ•°ï¼‰ ============= */
async function startMatchingProcess(rowId) {
    activeRowId = rowId;
    // é¡¶éƒ¨æ ‡é¢˜æ˜¾ç¤ºå½“å‰è®°å½• ID
    dom.originalColorDisplay.innerText = rowId; 
    
    // éšè—é…ç½®å¡ç‰‡ï¼Œæ˜¾ç¤ºåŒ¹é…å†…å®¹å’Œåº•éƒ¨æ 
    dom.configCard.classList.add('hidden');
    dom.matchingContent.classList.remove('hidden');
    dom.footerBar.classList.remove('hidden');

    // æ¸…ç©ºçŠ¶æ€
    dom.statusMessage.innerText = "æ­£åœ¨åŠ è½½å€™é€‰é¢œè‰²â€¦";
    dom.submitBtn.disabled = true;

    // è½½å…¥å€™é€‰æ•°æ®
    await loadCandidate(rowId);

    // ç»‘å®šæäº¤æŒ‰é’®äº‹ä»¶ï¼ˆç¡®ä¿åªç»‘å®šä¸€æ¬¡ï¼‰
    dom.submitBtn.onclick = () => updateColor(rowId);
}

/* ============= æ‰‹åŠ¨å¯åŠ¨å¤„ç†å‡½æ•° ============= */
function handleManualStart() {
    const rowId = dom.manualRowId.value.trim();

    if (!rowId) {
        dom.configStatus.classList.remove('hidden');
        dom.configStatus.innerText = 'é”™è¯¯ï¼šè®°å½• ID ä¸èƒ½ä¸ºç©ºã€‚';
        return;
    }
    
    dom.configStatus.classList.add('hidden');
    dom.configStatus.innerText = '';
    
    // æ¸…é™¤åŠ è½½åŒºçš„æ—§æ•°æ®
    dom.candidateBox.innerHTML = '<p id="loading" class="col-span-full text-center text-gray-500 py-6">æ­£åœ¨åŠ è½½å€™é€‰é¢œè‰²â€¦</p>';
    // æ›´æ–° dom.loading å¼•ç”¨ï¼Œä»¥ä¾¿ loadCandidate å¯ä»¥æ‰¾åˆ°å®ƒ
    dom.loading = document.getElementById('loading'); 

    startMatchingProcess(rowId); // åªä¼ é€’ rowId
}


/* ============= è½½å…¥å€™é€‰é¢œè‰²æ•°æ® ============= */
async function loadCandidate(rowId){
    dom.loading.innerText = "æ­£åœ¨é€šè¿‡ API åŠ è½½è®°å½•...";

    try {
        const result = await mdPost(CONFIG.fetchUrl,{
            appKey: CONFIG.appKey,
            sign: CONFIG.sign,
            worksheetId: CONFIG.worksheetId,
            rowId: rowId, // ä½¿ç”¨ rowId
            getSystemControl: false
        });

        if(!result.success){
            // API æŠ¥å‘Šå¤±è´¥ï¼ˆä¾‹å¦‚ï¼šç­¾åé”™è¯¯ã€æƒé™ä¸è¶³ï¼‰
            dom.loading.innerHTML = `<span class="text-red-500">API æŠ¥å‘Šå¤±è´¥ï¼Œè¯·æ£€æŸ¥ AppKey/Sign/æƒé™ã€‚é”™è¯¯ç : ${result.error_code || 'æœªçŸ¥'}</span>`;
            dom.statusMessage.innerText = `åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API é…ç½®ã€‚`;
            return;
        }

        // å¢å¼ºæ£€æŸ¥ï¼šç¡®ä¿ rows æ•°ç»„å­˜åœ¨ä¸”ä¸ä¸ºç©º
        const rows = result.data?.rows;
        if (!rows || rows.length === 0) {
            dom.loading.innerHTML = `<span class="text-red-500">åŠ è½½å¤±è´¥ï¼šæœªæ‰¾åˆ°è®°å½• ID (${rowId})ï¼Œæˆ–æ•°æ®ç»“æ„å¼‚å¸¸ã€‚è¯·æ£€æŸ¥ ID æ˜¯å¦æœ‰æ•ˆã€‚</span>`;
            dom.statusMessage.innerText = `åŠ è½½å¤±è´¥ï¼šè®°å½• ID æ— æ•ˆæˆ–æƒé™ä¸è¶³ã€‚`;
            return;
        }

        const row = rows[0];
        const raw = row[CONFIG.candidateFieldId];

        if(!raw){
            dom.loading.innerText = "å€™é€‰å­—æ®µæ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥å­—æ®µé…ç½®ã€‚";
            dom.statusMessage.innerText = "è¯·æ£€æŸ¥å€™é€‰å­—æ®µæ•°æ®ã€‚";
            return;
        }

        let list = [];
        try{
            list = JSON.parse(raw);
        }catch(e){
            dom.loading.innerHTML = `<span class="text-red-500">å€™é€‰å­—æ®µ JSON æ ¼å¼é”™è¯¯: ${e.message}</span>`;
            dom.statusMessage.innerText = "å€™é€‰å­—æ®µ JSON æ ¼å¼é”™è¯¯ã€‚";
            return;
        }

        /* color å»é‡ */
        const unique = new Map();
        list.forEach(item => {
            // ç¡®ä¿é¢œè‰²å’Œå›¾ç‰‡URLéƒ½å­˜åœ¨æ‰ç®—æœ‰æ•ˆå€™é€‰
            if(item.color && item.logoUrl && !unique.has(item.color)){
                // item åŒ…å«äº† sku, logoUrl, color ç­‰ä¿¡æ¯
                unique.set(item.color, item);
            }
        });
        
        // å¦‚æœå€™é€‰é›†ä¸ºç©º
        if (unique.size === 0) {
            dom.loading.innerText = "æœªæ‰¾åˆ°æœ‰æ•ˆçš„å€™é€‰å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥ JSON æ•°æ®ç»“æ„ã€‚";
            dom.statusMessage.innerText = "æœªæ‰¾åˆ°æœ‰æ•ˆå€™é€‰é›†ã€‚";
            return;
        }

        // ç¡®ä¿dom.loadingå­˜åœ¨ï¼Œé¿å…é”™è¯¯
        if (dom.loading && dom.loading.parentNode) {
            dom.loading.remove(); // ç§»é™¤åŠ è½½æç¤º
        }
        renderCandidates([...unique.values()]);

    } catch (e) {
        // ç½‘ç»œè¯·æ±‚æœ¬èº«å¤±è´¥ï¼ˆä¾‹å¦‚ CORS é˜»æ­¢æˆ–æœåŠ¡å™¨æ— æ³•è¿æ¥ï¼‰
        dom.loading.innerHTML = `<span class="text-red-500">ç½‘ç»œè¯·æ±‚å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CORS è®¾ç½®ï¼š${e.message}</span>`;
        dom.statusMessage.innerText = "ç½‘ç»œè¯·æ±‚å¤±è´¥ã€‚";
    }
}

/* ============= æ¸²æŸ“é¢œè‰²å¡ç‰‡ ============= */
function renderCandidates(list){
    dom.candidateBox.innerHTML = "";

    list.forEach(item => {
        const d = document.createElement("div");
        d.className =
            "bg-white rounded-xl shadow-md border-4 border-gray-200 cursor-pointer p-2 transition transform hover:scale-[1.02] active:scale-[0.98]";
        d.onclick = () => chooseColor(item, d);

        d.innerHTML = `
            <img src="${item.logoUrl}" 
                 onerror="this.src='https://placehold.co/200x250/AAAAAA/FFFFFF?text=å›¾ç‰‡ç¼ºå¤±'"
                 alt="${item.color}"
                 class="w-full h-32 object-cover rounded-lg">
            <p class="text-center mt-2 text-sm font-bold truncate" title="${item.color}">${item.color}</p>
        `;
        dom.candidateBox.appendChild(d);
    });

    dom.statusMessage.innerText = "è¯·é€‰æ‹©ä¸€ä¸ªé¢œè‰²å›¾ç‰‡è¿›è¡ŒåŒ¹é…";
}

/* ============= é€‰æ‹©é¢œè‰² ============= */
function chooseColor(item, el){
    // item æ˜¯åŒ…å« color, sku, logoUrl çš„å®Œæ•´å¯¹è±¡
    selectedColor = item;

    // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­æ ·å¼
    document.querySelectorAll("#candidate-box > div")
        .forEach(x => x.classList.remove("border-secondary","ring-4", "ring-secondary/50"));

    // åº”ç”¨æ–°çš„é€‰ä¸­æ ·å¼
    el.classList.add("border-secondary","ring-4", "ring-secondary/50");
    dom.statusMessage.innerText = "å·²é€‰æ‹©ï¼š" + item.color + " (SKU: " + (item.dwSkuId || item.sku || 'N/A') + ")";
    dom.submitBtn.disabled = false;
}

/* ============= æ›´æ–°é¢œè‰²åˆ°æ˜é“äº‘ ============= */
async function updateColor(rowId){
    if (!selectedColor || isProcessing) return;

    isProcessing = true;
    dom.submitBtn.textContent = 'ä¼ è¾“ä¸­...';
    dom.submitBtn.disabled = true;
    dom.statusMessage.innerText = "æ­£åœ¨è°ƒç”¨æ˜é“äº‘ API æ›´æ–°è®°å½•...";

    try {
        const controlsPayload = [];
        
        // 1. å†™å…¥é¢œè‰²ååˆ°ç›®æ ‡å­—æ®µ
        controlsPayload.push({
            controlId: CONFIG.colorFieldId,
            value: selectedColor.color
        });
        
        // ã€å¯é€‰æ”¹è¿›ã€‘å¦‚æœéœ€è¦å›ä¼ å›¾ç‰‡é™„ä»¶å­—æ®µï¼Œå¯ä»¥åœ¨æ­¤å¤„æ·»åŠ 
        // if (CONFIG.matchedImageFieldId && selectedColor.logoUrl) {
        //     const urlParts = selectedColor.logoUrl.split('/');
        //     const fileName = urlParts[urlParts.length - 1].split('?')[0];
        //     controlsPayload.push({
        //         controlId: CONFIG.matchedImageFieldId,
        //         value: JSON.stringify([{ "previewUrl": selectedColor.logoUrl, "name": fileName }]) 
        //     });
        // }


        const res = await mdPost(CONFIG.updateUrl,{
            appKey: CONFIG.appKey,
            sign: CONFIG.sign,
            worksheetId: CONFIG.worksheetId,
            rowId: rowId, // ä½¿ç”¨ rowId
            triggerWorkflow: true,
            controls: controlsPayload
        });

        if(!res.success){
            dom.statusMessage.innerHTML = `<span class="text-red-500">æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥å­—æ®µæƒé™ã€‚é”™è¯¯ä¿¡æ¯: ${res.error_msg || 'æœªçŸ¥é”™è¯¯'}</span>`;
            // å¤±è´¥åå…è®¸é‡æ–°å°è¯•
            dom.submitBtn.textContent = 'æ›´æ–°å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
            dom.submitBtn.disabled = false;
            isProcessing = false;
            return;
        }

        dom.statusMessage.innerText = "âœ“ è®°å½•å·²æˆåŠŸæ›´æ–°ï¼š" + selectedColor.color;
        dom.submitBtn.textContent = 'âœ“ å·²å®Œæˆ';
        dom.submitBtn.classList.remove('bg-secondary');
        dom.submitBtn.classList.add('bg-gray-400'); // å®Œæˆåå˜ç°
        
        // æˆåŠŸåä¹Ÿå¯ä»¥é€šçŸ¥çˆ¶çª—å£ï¼ˆæ˜é“äº‘ï¼‰
        window.parent.postMessage({
            type: 'IMAGE_MATCH_SUCCESS', 
            payload: { rowId: rowId, matchedColor: selectedColor.color }
        }, '*'); 

    } catch (e) {
        dom.statusMessage.innerHTML = `<span class="text-red-500">æ›´æ–°è¯·æ±‚å¤±è´¥ï¼š${e.message}</span>`;
        dom.submitBtn.textContent = 'æ›´æ–°å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
        dom.submitBtn.disabled = false;
        isProcessing = false;
    }

    isProcessing = false;
}

/* ============= é¡µé¢å¯åŠ¨å…¥å£ ============= */
window.onload = async () => {
    const params = getUrlParams();
    const rowId = params.rowId;

    if(rowId){
        // 1. URL ä¸­å­˜åœ¨ rowIdï¼Œç›´æ¥å¼€å§‹åŒ¹é…æµç¨‹
        startMatchingProcess(rowId);
    } else {
        // 2. URL ä¸­ç¼ºå°‘ rowIdï¼Œæ˜¾ç¤ºé…ç½®è¾“å…¥å¡ç‰‡
        dom.originalColorDisplay.innerText = 'è¯·é…ç½®ä»»åŠ¡';
        dom.configCard.classList.remove('hidden');
        dom.matchingContent.classList.add('hidden');
        dom.footerBar.classList.add('hidden');
        dom.statusMessage.innerText = 'ç­‰å¾…è¾“å…¥ä»»åŠ¡ä¿¡æ¯...';

        // ç»‘å®šæ‰‹åŠ¨å¯åŠ¨æŒ‰é’®
        dom.startButton.onclick = handleManualStart;
        
        // å…è®¸ç”¨æˆ·æŒ‰å›è½¦é”®å¯åŠ¨
        dom.manualRowId.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleManualStart();
        });
    }
};

</script>

</body>
</html>
