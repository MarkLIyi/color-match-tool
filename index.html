<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>图片颜色比对工作台</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
    .hide-scrollbar::-webkit-scrollbar { display:none; }
    .hide-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }

    /* 明道云 iframe 修复 */
    #settings-modal {
        position: fixed !important;
        z-index: 999999 !important;
        pointer-events: auto !important;
    }

    body {
        pointer-events: auto !important;
    }
</style>
</head>

<body class="bg-gray-50 min-h-screen">

<!-- 顶部 -->
<header class="bg-white shadow-sm p-4 sticky top-0 z-10">
    <div class="max-w-5xl mx-auto flex justify-between">
        <h1 class="text-xl font-bold">
            待匹配颜色：<span id="original-color" class="text-primary">加载中...</span>
        </h1>
    </div>
</header>

<!-- 主体 -->
<main class="max-w-5xl mx-auto p-4">
    <h2 class="text-lg font-semibold mb-3">候选颜色</h2>

    <div id="candidate-box" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 hide-scrollbar">
        <p id="loading" class="col-span-full text-center text-gray-500 py-6">正在加载候选颜色…</p>
    </div>
</main>

<!-- 底部 -->
<div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-md p-4">
    <div class="max-w-5xl mx-auto flex justify-between">
        <span id="status" class="text-gray-700">请选择一个颜色图片</span>
        <button id="submit-btn" disabled class="bg-green-400 text-white px-6 py-2 rounded-lg font-bold disabled:opacity-50">
            ✓ 确认匹配
        </button>
    </div>
</div>

<script>
// ---------------------------
// 固定明道云配置（全写死）
// ---------------------------
const CONFIG = {
    appKey: "681a78e1b8c72330",
    sign: "M2NkZGZiMmM5OWIyMTUxMDQ4N2Y2YTAwZTMxNDJmM2Q3NWI5ZmU4MGU4ZDcxZjlhYWI1ZTUyOWJmNDgxYWU2OQ==",
    worksheetId: "sjclb",

    // 固定字段
    candidateFieldId: "69044f51be2ffd8cd20d153e",
    colorFieldId: "6901b59fbe2ffd8cd2ab5d73",

    // 固定接口地址（你刚提供的）
    fetchUrl: "https://www.dedlion.com/api/v2/open/worksheet/getRowByIdPost",
    updateUrl: "https://www.dedlion.com/api/v2/open/worksheet/editRowPost"
};

// ---------------------------
// 工具函数
// ---------------------------

// 获取 URL 中 rowId 参数
function getRowId() {
    return new URLSearchParams(location.search).get("rowId");
}

// 明道云 POST 工具
async function mdPost(url, body) {
    const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });
    return r.json();
}

let selectedColor = null;

// ---------------------------
// 加载候选颜色
// ---------------------------

async function loadCandidate(rowId) {
    const result = await mdPost(CONFIG.fetchUrl, {
        appKey: CONFIG.appKey,
        sign: CONFIG.sign,
        worksheetId: CONFIG.worksheetId,
        rowId: rowId,
        getSystemControl: false
    });

    const loadingEl = document.getElementById("loading");

    if (!result.success) {
        loadingEl.innerText = "加载失败，请检查 Key / Sign";
        return;
    }

    const row = result.data.rows[0];
    const rawText = row[CONFIG.candidateFieldId];

    if (!rawText) {
        loadingEl.innerText = "候选颜色字段为空";
        return;
    }

    let list = [];
    try {
        list = JSON.parse(rawText);
    } catch (e) {
        loadingEl.innerText = "候选颜色 JSON 格式错误";
        return;
    }

    // 根据颜色去重
    const unique = new Map();
    list.forEach(item => {
        if (!unique.has(item.color)) unique.set(item.color, item);
    });

    renderCandidates([...unique.values()]);
}

// ---------------------------
// 渲染颜色候选项
// ---------------------------
function renderCandidates(list) {
    const box = document.getElementById("candidate-box");
    box.innerHTML = "";

    list.forEach(item => {
        const d = document.createElement("div");
        d.className = "bg-white rounded shadow hover:shadow-lg cursor-pointer p-2 border";
        d.onclick = () => chooseColor(item.color, d);

        d.innerHTML = `
            <img src="${item.logoUrl}" class="w-full h-32 object-cover rounded"/>
            <p class="text-center mt-2 text-sm font-bold">${item.color}</p>
        `;
        box.appendChild(d);
    });
}

// ---------------------------
// 选择颜色
// ---------------------------
function chooseColor(color, el) {
    selectedColor = color;

    document.querySelectorAll("#candidate-box > div")
        .forEach(x => x.classList.remove("border-green-400", "border-4"));

    el.classList.add("border-green-400", "border-4");

    document.getElementById("status").innerText = "已选择：" + color;
    document.getElementById("submit-btn").disabled = false;
}

// ---------------------------
// 回写明道云
// ---------------------------
async function updateColor(rowId) {
    const result = await mdPost(CONFIG.updateUrl, {
        appKey: CONFIG.appKey,
        sign: CONFIG.sign,
        worksheetId: CONFIG.worksheetId,
        rowId: rowId,
        triggerWorkflow: true,
        controls: [
            { controlId: CONFIG.colorFieldId, value: selectedColor }
        ]
    });

    if (!result.success) {
        document.getElementById("status").innerText = "更新失败，请检查字段配置";
        return;
    }

    document.getElementById("status").innerText = "✓ 已更新：" + selectedColor;
}

// ---------------------------
// 页面入口
// ---------------------------
window.onload = async () => {
    const rowId = getRowId();
    if (!rowId) {
        alert("URL 缺少 rowId，例如：?rowId=行记录ID");
        return;
    }

    document.getElementById("original-color").innerText = rowId;

    await loadCandidate(rowId);

    document.getElementById("submit-btn").onclick = () => updateColor(rowId);
};

</script>
</body>
</html>
