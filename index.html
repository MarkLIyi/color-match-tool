<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片颜色比对工作台</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = { 
            theme:{ 
                extend:{ 
                    colors:{ primary:"#4f46e5", secondary:"#10b981" }
                }
            }
        };
    </script>

    <style>
        .hide-scrollbar::-webkit-scrollbar { display:none; }
        .hide-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }

        /* 修复明道云 iframe 导致弹窗无法点击 */
        #settings-modal {
            position: fixed !important;
            z-index: 999999 !important;
            pointer-events: auto !important;
        }

        /* 强制允许点击（明道云 iframe 会阻断 pointer-events） */
        body {
            pointer-events: auto !important;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow-sm p-4 sticky top-0 z-10">
    <div class="max-w-5xl mx-auto flex justify-between">
        <h1 class="text-xl font-bold">待匹配颜色：<span id="original-color" class="text-primary">加载中...</span></h1>
        <button id="open-settings" class="p-2 rounded hover:bg-gray-100">⚙️ 设置</button>
    </div>
</header>

<main class="max-w-5xl mx-auto p-4">
    <h2 class="text-lg font-semibold mb-3">候选颜色</h2>

    <div id="candidate-box" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 hide-scrollbar">
        <p id="loading" class="col-span-full text-center text-gray-500 py-6">正在加载候选颜色…</p>
    </div>
</main>

<div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-md p-4">
    <div class="max-w-5xl mx-auto flex justify-between">
        <span id="status" class="text-gray-700">请选择一个颜色图片</span>
        <button id="submit-btn" disabled class="bg-secondary text-white px-6 py-2 rounded-lg font-bold disabled:opacity-50">✓ 确认匹配</button>
    </div>
</div>

<!-- 设置弹窗 -->
<div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg">
        <h3 class="text-xl font-bold mb-4">API 配置</h3>

        <label class="block mb-2 text-sm">AppKey：
            <input id="cfg-appKey" class="w-full border rounded p-2 mt-1"/>
        </label>

        <label class="block mb-2 text-sm">Sign（你自己生成）：
            <input id="cfg-sign" class="w-full border rounded p-2 mt-1"/>
        </label>

        <label class="block mb-2 text-sm">WorksheetId：
            <input id="cfg-wid" class="w-full border rounded p-2 mt-1"/>
        </label>

        <label class="block mb-2 text-sm">候选字段 ID：
            <input id="cfg-candidate" class="w-full border rounded p-2 mt-1" placeholder="69044f51be2ffd8cd20d153e"/>
        </label>

        <label class="block mb-2 text-sm">回写颜色字段 ID：
            <input id="cfg-colorField" class="w-full border rounded p-2 mt-1" placeholder="6901b59fbe2ffd8cd2ab5d73"/>
        </label>

        <label class="block mb-2 text-sm">获取接口 URL：
            <input id="cfg-fetchUrl" class="w-full border rounded p-2 mt-1" placeholder="https://你的域名/api/v2/open/worksheet/getRowByIdPost"/>
        </label>

        <label class="block mb-4 text-sm">更新接口 URL：
            <input id="cfg-updateUrl" class="w-full border rounded p-2 mt-1" placeholder="https://你的域名/api/v2/open/worksheet/editRowPost"/>
        </label>

        <div class="flex justify-end space-x-3">
            <button id="close-settings" class="px-4 py-2 rounded bg-gray-100">取消</button>
            <button id="save-settings" class="px-4 py-2 rounded bg-primary text-white">保存</button>
        </div>
    </div>
</div>

<script>
/* iframe 自动修复补丁：明道云中必须执行 */
if (window !== window.parent) {
    console.log("Running inside Mingdao iframe");

    document.body.style.pointerEvents = "auto";

    const fix = () => {
        const modal = document.getElementById("settings-modal");
        if (modal) {
            modal.style.zIndex = "999999";
            modal.style.pointerEvents = "auto";
            modal.style.position = "fixed";
        }
    };

    new MutationObserver(fix).observe(document.body, { childList: true, subtree: true });
    fix();
}

/* 本地配置读取工具 */
const LS = key => localStorage.getItem(key) || "";

/* 保存设置 */
function saveConfig(){
    localStorage.setItem("appKey", cfg-appKey.value.trim());
    localStorage.setItem("sign", cfg-sign.value.trim());
    localStorage.setItem("worksheetId", cfg-wid.value.trim());
    localStorage.setItem("candidateFieldId", cfg-candidate.value.trim());
    localStorage.setItem("colorFieldId", cfg-colorField.value.trim());
    localStorage.setItem("fetchUrl", cfg-fetchUrl.value.trim());
    localStorage.setItem("updateUrl", cfg-updateUrl.value.trim());
    alert("配置已保存");
    closeSettings();
}

/* 加载设置到界面 */
function loadConfigToUI(){
    cfg-appKey.value = LS("appKey");
    cfg-sign.value = LS("sign");
    cfg-wid.value = LS("worksheetId");
    cfg-candidate.value = LS("candidateFieldId");
    cfg-colorField.value = LS("colorFieldId");
    cfg-fetchUrl.value = LS("fetchUrl");
    cfg-updateUrl.value = LS("updateUrl");
}

open-settings.onclick = ()=>{
    settings-modal.classList.remove("hidden");
    settings-modal.classList.add("flex");
    loadConfigToUI();
};

close-settings.onclick = ()=>{
    settings-modal.classList.add("hidden");
    settings-modal.classList.remove("flex");
};

/* 获取 URL 参数中的 rowId */
function getRowIdFromUrl(){
    const p = new URLSearchParams(location.search);
    return p.get("rowId");
}

/* 明道云 POST 工具 */
async function mdPost(url, body){
    const r = await fetch(url,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(body)
    });
    return r.json();
}

let selectedColor = null;

/* 加载候选颜色数据 */
async function loadCandidate(rowId){
    const result = await mdPost(LS("fetchUrl"),{
        appKey: LS("appKey"),
        sign: LS("sign"),
        worksheetId: LS("worksheetId"),
        rowId,
        getSystemControl: false
    });

    const loading = document.getElementById("loading");

    if(!result.success){
        loading.innerText = "加载失败，请检查 Key / Sign";
        return;
    }

    const row = result.data.rows[0];
    const raw = row[LS("candidateFieldId")];

    if(!raw){
        loading.innerText = "候选颜色字段为空";
        return;
    }

    let list = [];
    try{
        list = JSON.parse(raw);
    }catch{
        loading.innerText = "候选字段 JSON 格式错误";
        return;
    }

    /* 根据颜色去重 */
    const unique = new Map();
    list.forEach(item => {
        if(!unique.has(item.color)) unique.set(item.color, item);
    });

    renderCandidates([...unique.values()]);
}

/* 渲染颜色候选项 */
function renderCandidates(list){
    const box = document.getElementById("candidate-box");
    box.innerHTML = "";

    list.forEach(item => {
        const d = document.createElement("div");
        d.className = "bg-white rounded shadow hover:shadow-lg cursor-pointer p-2 border";
        d.onclick = () => chooseColor(item.color, d);

        d.innerHTML = `
            <img src="${item.logoUrl}" class="w-full h-32 object-cover rounded">
            <p class="text-center mt-2 text-sm font-bold">${item.color}</p>
        `;
        box.appendChild(d);
    });

    document.getElementById("loading")?.remove();
}

/* 选择颜色 */
function chooseColor(color, el){
    selectedColor = color;

    document.querySelectorAll("#candidate-box > div")
        .forEach(x => x.classList.remove("border-secondary","border-4"));

    el.classList.add("border-secondary","border-4");
    status.innerText = "已选择：" + color;
    submit-btn.disabled = false;
}

/* 回写颜色到明道云 */
async function updateColor(rowId){
    const res = await mdPost(LS("updateUrl"),{
        appKey: LS("appKey"),
        sign: LS("sign"),
        worksheetId: LS("worksheetId"),
        rowId,
        triggerWorkflow: true,
        controls: [
            { controlId: LS("colorFieldId"), value: selectedColor }
        ]
    });

    if(!res.success){
        status.innerText = "更新失败，请检查字段配置";
        return;
    }

    status.innerText = "✓ 已更新：" + selectedColor;
    submit-btn.disabled = true;
}

/* 页面加载入口 */
window.onload = async ()=>{
    const rowId = getRowIdFromUrl();

    if(!rowId){
        alert("URL 缺少 rowId 参数，请使用：?rowId=记录ID");
        return;
    }

    original-color.innerText = rowId;

    await loadCandidate(rowId);

    submit-btn.onclick = () => updateColor(rowId);
};
</script>

</body>
</html>
